<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tạo Đơn Hàng Mới (Doanh Nghiệp)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="./price-table.js"></script> 
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap');
        body { background: #e5eefb; font-family: 'Be Vietnam Pro', sans-serif; }
        .bg-logo-bg { pointer-events: none; position: fixed; z-index: -1; left: 0; top: 0; width: 100vw; height: 100vh; overflow: hidden; }
        .bg-logo-bg-inner { position: absolute; left: 50%; top: 50%; width: 200vw; height: 200vh; transform: translate(-50%, -50%) rotate(-10deg); background-image: url('https://i.postimg.cc/yd4v4YHG/EZ-LOGO-31.png'); background-repeat: repeat; background-size: 120px auto; opacity: 0.07; }
        .form-container { background: #fff; border-radius: 16px; box-shadow: 0 2px S-10px 0 rgba(0,0,0,0.06); border: 1px solid #bee3f8; padding: 2.5rem; }
        .price-info-highlight { background: #fef2f2; color: #b91c1c; font-weight: bold; border-radius: 5px; padding: 0.3em 0.7em; margin-top: 5px; display: inline-block; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="bg-logo-bg"><div class="bg-logo-bg-inner"></div></div>
    <main>
        <div class="form-container max-w-4xl mx-auto">
            <div class="text-center mb-8">
                <img src="https://i.postimg.cc/VvSyGkBV/EZ-LOGO-08.png" alt="EZ Maya Logo" class="h-14 w-auto mx-auto mb-4">
                <h1 class="text-3xl font-extrabold text-gray-900">Tạo Đơn Hàng Dịch Vụ</h1>
                <div id="info-display" class="mt-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-left max-w-md mx-auto">
                    <p id="company-name" class="text-gray-700 font-semibold text-center text-lg"></p>
                    <p id="discount-info" class="text-green-600 font-bold text-center"></p>
                </div>
            </div>
            <form id="wifi-form" autocomplete="on">
                <h2 class="text-xl font-bold text-gray-800 border-b-2 border-gray-200 pb-2 mb-6">Chi Tiết Đơn Hàng</h2>
                <div id="rental-requests-container" class="space-y-8 mb-8"></div>
                <div class="flex justify-center mb-8">
                    <button id="add-request-btn" type="button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition">
                        + Thêm Đơn Hàng
                    </button>
                </div>

                <h2 class="text-xl font-bold text-gray-800 border-b-2 border-gray-200 pb-2 mb-6">Thông Tin Vận Chuyển</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Tên người nhận<span class="text-red-500">*</span></label>
                        <input type="text" id="shipping-recipient" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">SĐT người nhận<span class="text-red-500">*</span></label>
                        <input type="tel" id="shipping-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Địa chỉ nhận hàng<span class="text-red-500">*</span></label>
                        <textarea id="shipping-address" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></textarea>
                    </div>
                </div>

                <div class="flex justify-center mt-10">
                    <button id="submit-form-btn" type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transition flex items-center justify-center gap-2">
                        <span id="submit-text">Gửi Yêu Cầu</span>
                        <span id="loading-spinner" class="hidden h-5 w-5 animate-spin rounded-full border-b-2 border-white"></span>
                    </button>
                </div>
            </form>
        </div>
    </main>
    <script>
        // --- CONFIG ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwqKgCKJune5u9ezFieKBaTY-P78jOiWExBBgLB7SD-0Yr5svIUn3gsGs-DVHsNvnuf/exec';
        const UNIT_NAME = "CorporateOrders";
        const PACKAGE_LIST = ["500MB/ngày", "1GB/ngày", "5GB/ngày"];
        const COUNTRY_LIST = typeof PRICE_TABLE !== 'undefined' ? Object.keys(PRICE_TABLE).sort() : [];
        let requestCounter = 0;
        let currentDiscountPercent = 0;
        let loggedInTaxCode = '';

        // --- ELEMENTS ---
        const form = document.getElementById('wifi-form');
        const container = document.getElementById('rental-requests-container');
        const addRequestBtn = document.getElementById('add-request-btn');
        const submitBtn = document.getElementById('submit-form-btn');
        const submitText = document.getElementById('submit-text');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- HELPER FUNCTIONS ---
        const currency = (val) => val != null ? Number(val).toLocaleString("vi-VN") + " VND" : "-";
        
        const calcDays = (from, to) => {
            if (!from || !to) return 1;
            const d1 = Date.UTC(...from.split('-').map((v, i) => i === 1 ? v - 1 : v));
            const d2 = Date.UTC(...to.split('-').map((v, i) => i === 1 ? v - 1 : v));
            const ms = d2 - d1;
            if (ms < 0) return 1;
            return Math.round(ms / 86400000) + 1;
        };

        const calcPrice = (country, pkg, days) => {
            if (typeof PRICE_TABLE === 'undefined' || !PRICE_TABLE[country] || !PACKAGE_LIST.includes(pkg) || !days) return null;
            const unit = PRICE_TABLE[country][pkg];
            if (unit === null || typeof unit === 'undefined') return null;
            
            const total = unit * days;
            const discountAmount = Math.round(total * (currentDiscountPercent / 100));
            const totalAfterDiscount = total - discountAmount;
            const vat = Math.round(totalAfterDiscount * 0.1);
            const grandTotal = totalAfterDiscount + vat;

            return { days, total, unitPrice: unit, vat, grandTotal, discountAmount, discountPercent: currentDiscountPercent };
        };

        function updatePriceForSection(section) {
            const country = section.querySelector('.choices-country').value;
            const pkg = section.querySelector('.package-select').value;
            const from = section.querySelector('.date-from').value;
            const to = section.querySelector('.date-to').value;
            const priceInfo = section.querySelector('.price-info');

            const days = calcDays(from, to);
            section.querySelector('.days-input').value = days;

            const result = calcPrice(country, pkg, days);
            
            if (!country || !pkg || !from || !to) {
                priceInfo.innerHTML = '';
                return;
            }

            if (result && result.unitPrice != null) {
                let priceHTML = `Đơn giá: ${currency(result.unitPrice)} x ${days} ngày = ${currency(result.total)}<br>`;
                if (result.discountPercent > 0) {
                    priceHTML += `Chiết khấu (${result.discountPercent}%): -${currency(result.discountAmount)}<br>`;
                }
                priceHTML += `VAT (10%): ${currency(result.vat)}<br><span class="text-indigo-600">Tổng cộng: ${currency(result.grandTotal)}</span>`;
                priceInfo.innerHTML = `<div class="price-info-highlight mt-4">${priceHTML}</div>`;
            } else {
                priceInfo.innerHTML = '<div class="mt-4 text-red-600 font-semibold">Gói cước không áp dụng cho quốc gia này.</div>';
            }
        }

        function updateSectionNumbers() {
            const sections = container.querySelectorAll('section.rental-request');
            sections.forEach((section, idx) => {
                const n = idx + 1;
                section.querySelector('h3.request-title').innerHTML = `Đơn Hàng #${n}`;
                section.querySelector('.remove-request-btn').style.display = sections.length > 1 ? 'inline-block' : 'none';
            });
            requestCounter = sections.length;
        }

        function createRentalRequestSection() {
            requestCounter++;
            const section = document.createElement('section');
            section.className = 'rental-request bg-gray-50 p-6 rounded-lg border';
            let countryOptions = COUNTRY_LIST.map(c => `<option value="${c}">${c}</option>`).join('');
            section.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="request-title text-xl font-bold text-gray-800">Đơn Hàng #${requestCounter}</h3>
                    <button type="button" class="remove-request-btn text-red-500 hover:text-red-700 font-semibold text-sm">Xóa</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-gray-700 text-sm font-semibold mb-2">Tên người dùng<span class="text-red-500">*</span></label><input type="text" class="user-name-input w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                    <div><label class="block text-gray-700 text-sm font-semibold mb-2">Quốc gia<span class="text-red-500">*</span></label><select class="choices-country w-full" required><option value="">-- Chọn quốc gia --</option>${countryOptions}</select></div>
                    <div><label class="block text-gray-700 text-sm font-semibold mb-2">Từ ngày<span class="text-red-500">*</span></label><input type="date" class="date-from w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                    <div><label class="block text-gray-700 text-sm font-semibold mb-2">Đến ngày<span class="text-red-500">*</span></label><input type="date" class="date-to w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                    <div class="md:col-span-2"><label class="block text-gray-700 text-sm font-semibold mb-2">Gói data<span class="text-red-500">*</span></label><select class="package-select w-full px-4 py-2 border border-gray-300 rounded-lg" required><option value="">-- Chọn gói data --</option><option value="500MB/ngày">500MB/ngày</option><option value="1GB/ngày">1GB/ngày</option><option value="5GB/ngày">5GB/ngày</option></select></div>
                    <div><label class="block text-gray-700 text-sm font-semibold mb-2">Số ngày sử dụng</label><input type="number" class="days-input w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly></div>
                    <div class="price-info col-span-1 md:col-span-2"></div>
                </div>`;
            container.appendChild(section);
            new Choices(section.querySelector('.choices-country'), { searchEnabled: true, shouldSort: false, itemSelectText: 'Chọn' });
            updateSectionNumbers();
        }

        function setSubmitState(enabled) {
            submitBtn.disabled = !enabled;
            loadingSpinner.classList.toggle('hidden', enabled);
            submitText.style.display = enabled ? 'block' : 'none';
        }
        
        async function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            loggedInTaxCode = urlParams.get('taxCode');

            if (!loggedInTaxCode) {
                document.getElementById('info-display').innerHTML = '<p class="text-red-600 text-center">Lỗi: Không tìm thấy thông tin đăng nhập. Vui lòng quay lại và đăng nhập.</p>';
                form.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?action=getAccountInfo&taxCode=${loggedInTaxCode}`);
                const result = await response.json();
                if (result.result === 'success' && result.data) {
                    document.getElementById('company-name').textContent = `Xin chào, ${result.data.companyName}`;
                    currentDiscountPercent = result.data.discount || 0;
                    document.getElementById('discount-info').textContent = `Mức chiết khấu tự động của bạn: ${currentDiscountPercent}%`;
                } else {
                     throw new Error('Không thể tải thông tin tài khoản.');
                }
            } catch(e) {
                document.getElementById('info-display').innerHTML = `<p class="text-red-600 text-center">Lỗi kết nối: ${e.message}</p>`;
                form.style.display = 'none';
            }
             createRentalRequestSection();
        }

        // --- EVENT LISTENERS ---
        addRequestBtn.addEventListener('click', createRentalRequestSection);
        container.addEventListener('change', (e) => e.target.closest('section.rental-request') && updatePriceForSection(e.target.closest('section.rental-request')));
        container.addEventListener('click', (e) => {
            if (e.target.matches('.remove-request-btn')) {
                const section = e.target.closest('section.rental-request');
                const choicesInstance = section.querySelector('.choices-country').choices;
                if (choicesInstance) choicesInstance.destroy();
                section.remove();
                updateSectionNumbers();
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setSubmitState(false);
            
            const shippingInfo = {
                recipient: document.getElementById('shipping-recipient').value.trim(),
                phone: document.getElementById('shipping-phone').value.trim(),
                address: document.getElementById('shipping-address').value.trim(),
            };

            if (!shippingInfo.recipient || !shippingInfo.phone || !shippingInfo.address) {
                Swal.fire("Thiếu thông tin vận chuyển", "Vui lòng điền đầy đủ thông tin nhận hàng.", "warning");
                setSubmitState(true); return;
            }

            let rentalRequests = [];
            let isFormValid = true;
            const sections = container.querySelectorAll('section.rental-request');
            if (sections.length === 0) {
                 Swal.fire("Chưa có đơn", "Vui lòng thêm ít nhất một đơn hàng.", "warning");
                 setSubmitState(true); return;
            }
            
            sections.forEach(section => {
                const price = calcPrice(section.querySelector('.choices-country').value, section.querySelector('.package-select').value, calcDays(section.querySelector('.date-from').value, section.querySelector('.date-to').value));
                const request = {
                    userName: section.querySelector('.user-name-input').value.trim(),
                    country: section.querySelector('.choices-country').value,
                    fromDate: section.querySelector('.date-from').value,
                    toDate: section.querySelector('.date-to').value,
                    dataPackage: section.querySelector('.package-select').value,
                    days: price?.days || 1,
                    unitPrice: price?.unitPrice || "",
                    total: price?.total || "",
                    vat: price?.vat || "",
                    grandTotal: price?.grandTotal || ""
                };
                if (!request.userName || !request.country || !request.fromDate || !request.toDate || !request.dataPackage) isFormValid = false;
                rentalRequests.push(request);
            });

            if (!isFormValid) {
                Swal.fire("Thiếu thông tin", "Vui lòng điền đầy đủ các trường bắt buộc cho tất cả đơn hàng.", "warning");
                setSubmitState(true); return;
            }

            const payload = { 
                unit: UNIT_NAME,
                loggedInTaxCode: loggedInTaxCode, // Gửi MST đã đăng nhập
                shippingInfo: shippingInfo,
                rentalRequests, 
                submissionTime: new Date().toISOString() 
            };
            
            try {
                const response = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    cache: 'no-cache', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                const result = await response.json();
                if (result.result !== "success") throw new Error(result.error || "Lỗi máy chủ.");
                await Swal.fire('Thành công!', 'Đơn hàng của bạn đã được gửi đi.', 'success');
                form.reset();
                container.innerHTML = '';
                createRentalRequest-section();
            } catch (err) {
                Swal.fire("Lỗi", `Không thể gửi đơn hàng. Chi tiết: ${err.message}`, "error");
            } finally {
                setSubmitState(true);
            }
        });
        
        // --- INITIALIZE ---
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>

