<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Đăng Ký Tài Khoản Doanh Nghiệp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap');
        body { 
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f0f4f8;
        }
        .glass-container {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .bg-logo-bg { position: fixed; z-index: -1; left: 0; top: 0; width: 100vw; height: 100vh; overflow: hidden; }
        .bg-logo-bg-inner { position: absolute; left: 50%; top: 50%; width: 200vw; height: 200vh; transform: translate(-50%, -50%) rotate(-10deg); background-image: url('https://i.postimg.cc/yd4v4YHG/EZ-LOGO-31.png'); background-repeat: repeat; background-size: 120px auto; opacity: 0.05; }
        .label-en { font-size:0.9em; color:#4f46e5; font-weight: 500; display:block; margin-top: 0.1rem; }
    </style>
</head>
<body class="antialiased">
    <div class="bg-logo-bg"><div class="bg-logo-bg-inner"></div></div>
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-2xl">
            <div class="glass-container rounded-2xl p-8 shadow-2xl">
                <div class="text-center mb-8">
                    <img src="https://i.postimg.cc/VvSyGkBV/EZ-LOGO-08.png" alt="EZ Maya Logo" class="h-14 w-auto mx-auto mb-4">
                    <h1 class="text-3xl font-extrabold text-gray-900">Tạo Tài Khoản Doanh Nghiệp</h1>
                    <p class="text-gray-500 mt-2">Hoàn tất thông tin để nhận chiết khấu và đặt hàng nhanh hơn.</p>
                </div>
                
                <form id="registration-form" class="space-y-6" autocomplete="on" novalidate>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Mã số thuế<span class="text-red-500">*</span> <span class="label-en">Tax Code</span></label>
                        <input type="text" id="tax-code" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white/70 focus:ring-2 focus:ring-indigo-500 transition" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Tên công ty<span class="text-red-500">*</span> <span class="label-en">Company Name</span></label>
                        <input type="text" id="company-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white/70 focus:ring-2 focus:ring-indigo-500 transition" required>
                    </div>
                     <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Địa chỉ<span class="text-red-500">*</span> <span class="label-en">Address</span></label>
                        <input type="text" id="company-address" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white/70 focus:ring-2 focus:ring-indigo-500 transition" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Tạo Mật khẩu<span class="text-red-500">*</span> <span class="label-en">Create Password</span></label>
                        <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white/70 focus:ring-2 focus:ring-indigo-500 transition" required>
                    </div>
                    <div class="pt-4">
                        <button id="submit-btn" type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-2">
                            <span id="submit-text">Đăng Ký</span>
                            <span id="loading-spinner" class="hidden h-5 w-5 animate-spin rounded-full border-b-2 border-white"></span>
                        </button>
                    </div>
                    <div class="text-center">
                        <a href="../index.html" class="text-sm font-medium text-indigo-600 hover:underline">« Quay lại trang đăng nhập</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwqKgCKJune5u9ezFieKBaTY-P78jOiWExBBgLB7SD-0Yr5svIUn3gsGs-DVHsNvnuf/exec';
            const form = document.getElementById('registration-form');
            const taxCodeInput = document.getElementById('tax-code');
            const companyNameInput = document.getElementById('company-name');
            const companyAddressInput = document.getElementById('company-address');
            const submitBtn = document.getElementById('submit-btn');
            const submitText = document.getElementById('submit-text');
            const loadingSpinner = document.getElementById('loading-spinner');

            let searchTimeout;
            taxCodeInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const taxCode = taxCodeInput.value.trim();
                if (taxCode.length >= 10) {
                    searchTimeout = setTimeout(() => {
                        fetchCompanyInfo(taxCode);
                    }, 500);
                }
            });

            async function fetchCompanyInfo(taxCode) {
                Swal.fire({ title: 'Đang tra cứu thông tin...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                try {
                    const response = await fetch(`https://api.vietqr.io/v2/business/${taxCode}`);
                    if (!response.ok) throw new Error('Không thể kết nối đến dịch vụ tra cứu.');
                    const result = await response.json();
                    
                    if (result.code === '00' && result.data) {
                        companyNameInput.value = result.data.name || '';
                        companyAddressInput.value = result.data.address || '';
                        Swal.close();
                    } else {
                        throw new Error(result.message || 'Không tìm thấy thông tin công ty.');
                    }
                } catch (error) {
                    Swal.fire('Lỗi Tra Cứu', error.message, 'error');
                }
            }
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                setSubmitState(false);

                const info = {
                    taxCode: taxCodeInput.value.trim(),
                    company: companyNameInput.value.trim(),
                    address: companyAddressInput.value.trim(),
                    password: document.getElementById('password').value
                };

                if (!info.taxCode || !info.company || !info.password) {
                    Swal.fire("Thiếu thông tin", "Vui lòng điền đầy đủ Mã số thuế, Tên công ty và Mật khẩu.", "warning");
                    setSubmitState(true);
                    return;
                }

                const payload = { 
                    isRegistration: true,
                    registrationData: info
                };

                try {
                    const response = await fetch(SCRIPT_URL, { 
                        method: 'POST', 
                        cache: 'no-cache', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    const result = await response.json();
                    if (result.result === "success") {
                        await Swal.fire({
                            icon: 'success',
                            title: 'Đăng ký thành công!',
                            text: 'Tài khoản đã được tạo. Bạn sẽ được chuyển về trang đăng nhập.',
                            timer: 2500,
                            showConfirmButton: false,
                            timerProgressBar: true
                        });
                        window.location.href = '../index.html';
                    } else {
                        throw new Error(result.error || "Lỗi không xác định từ máy chủ.");
                    }
                } catch (err) {
                    Swal.fire("Lỗi Đăng Ký", err.message, "error");
                } finally {
                    setSubmitState(true);
                }
            });

            function setSubmitState(enabled) {
                submitBtn.disabled = !enabled;
                loadingSpinner.classList.toggle('hidden', enabled);
                submitText.style.display = enabled ? 'block' : 'none';
            }
        });
    </script>
</body>
</html>

