/**
 * =================================================================
 * HẰNG SỐ TOÀN CỤC
 * =================================================================
 */
const SPREADSHEET_ID = "18v0MZ2iePT5ZsHM5dG3b_WbKzjAUcret3C2XU1hCdmo"; // ID Sheet của bạn
const DISCOUNT_SHEEET_NAME = "Discounts";
const INTERNAL_CC_EMAILS = [
    "adm2.mv@ezfivn.com", "info@ezfivn.com", "nhat.nam@ezfivn.com",
    "info@ez-vn.com", "t.sakaguchi@mayass.com"
];

const ACCOUNTS = {
  "his_user": { pass: "MAYAVIETNAM", url: "./HIS/index.html" },
  "toyota": { pass: "123456789", url: "./TOYOTA/index.html" }, // [SỬA LẠI MK]
  "yamaha": { pass: "0123456789", url: "./YAMAHA/index.html" }, // [SỬA LẠI MK]
  "mitsubishi": { pass: "0987654321", url: "./MITSUBISHI/index.html" } // [SỬA LẠI MK]
};

/**
 * =================================================================
 * ĐỊNH NGHĨA CẤU TRÚC CỘT (ĐÃ NÂNG CẤP)
 * =================================================================
 */

// [SỬA] Thêm "quantity" vào danh sách cột chính
const MASTER_COLUMNS = [
    { id: "recordTime", name: "Thời gian ghi", width: 150, format: "dd/MM/yyyy HH:mm:ss" },
    { id: "submissionTime", name: "Thời gian gửi", width: 150, format: "dd/MM/yyyy HH:mm" },
    { id: "emailStatus", name: "Trạng thái Email", width: 150 },
    { id: "name", name: "Họ tên", width: 120 }, { id: "email", name: "Email", width: 180 },
    { id: "phone", name: "Số điện thoại", width: 120 }, { id: "company", name: "Công ty", width: 150 },
    { id: "region", name: "Khu vực", width: 120 }, { id: "taxCode", name: "Mã số thuế", width: 120 },
    { id: "requestNumber", name: "Số thứ tự đơn", width: 120 }, 
    { id: "userName", name: "Tên người dùng", width: 120 }, // Dùng cho Đối tác
    { id: "imei", name: "IMEI", width: 120 }, // Dùng cho Đối tác
    { id: "quantity", name: "Số lượng", width: 90, format: "0" }, // [MỚI] Dùng cho Doanh nghiệp
    { id: "fromDate", name: "Từ ngày", width: 120, format: "dd/MM/yyyy" },
    { id: "toDate", name: "Đến ngày", width: 120, format: "dd/MM/yyyy" },
    { id: "days", name: "Số ngày sử dụng", width: 120, format: "0" },
    { id: "country", name: "Quốc gia", width: 120 }, { id: "dataPackage", name: "Gói data", width: 120 },
    { id: "budgetCode", name: "Budget Code", width: 120 }, // Dùng cho Đối tác
    { id: "discountPercent", name: "Chiết khấu (%)", width: 120, format: "0.0%" },
    { id: "discountAmount", name: "Số tiền giảm", width: 120, format: "#,##0" },
    { id: "unitPrice", name: "Đơn giá/ngày", width: 120, format: "#,##0" },
    { id: "total", name: "Thành tiền", width: 120, format: "#,##0" }, { id: "vat", name: "VAT (10%)", width: 120, format: "#,##0" },
    { id: "grandTotal", name: "Tổng cộng", width: 120, format: "#,##0" },
    { id: "shippingMethod", name: "Hình thức vận chuyển", width: 150 },
    { id: "shippingFee", name: "Phí vận chuyển", width: 120, format: "#,##0" },
    { id: "shippingDate", name: "Ngày giao hàng mong muốn", width: 160, format: "dd/MM/yyyy" },
    { id: "shippingRecipient", name: "Người nhận hàng", width: 150 },
    { id: "shippingPhone", name: "SĐT nhận hàng", width: 120 },
    { id: "shippingAddress", name: "Địa chỉ nhận hàng", width: 250 }
];

// Cột loại trừ cho Đối tác (Partner)
const PARTNER_EXCLUDE_IDS = [
    'quantity', 'discountPercent', 'discountAmount', 
    'shippingMethod', 'shippingFee', 'shippingDate',
    'shippingRecipient', 'shippingPhone', 'shippingAddress'
];

// Cột loại trừ cho Doanh nghiệp (Corporate)
const CORPORATE_EXCLUDE_IDS = [
    'userName', 'imei', 'budgetCode'
];

// [SỬA] Hàm này giờ sẽ chọn cột dựa trên "unit"
function getColumnsForUnit(unit) {
    let excludedIds = [];
    
    // Đối tác (KHÔNG có vận chuyển, chiết khấu, số lượng)
    if (unit === 'TOYOTA' || unit === 'YAMAHA' || unit === 'MITSUBISHI') {
        excludedIds = PARTNER_EXCLUDE_IDS;
    }
    // Doanh nghiệp (CÓ vận chuyển, chiết khấu, số lượng - KHÔNG có userName, imei)
    else if (unit === 'CorporateOrders') {
        excludedIds = CORPORATE_EXCLUDE_IDS;
    }
    // Đối tác HIS (CÓ vận chuyển - KHÔNG có chiết khấu, số lượng)
    else if (unit === 'HIS') {
        excludedIds = ['quantity', 'discountPercent', 'discountAmount'];
    }
    // Mặc định (nếu có)
    else {
        excludedIds = [];
    }

    return MASTER_COLUMNS.filter(col => !excludedIds.includes(col.id));
}

/**
 * =================================================================
 * HÀM XỬ LÝ ĐĂNG NHẬP VÀ CHIẾT KHẤU
 * (Giữ nguyên)
 * =================================================================
 */

function getDiscountData() {
    const cache = CacheService.getScriptCache();
    const cachedData = cache.get('discountData');
    if (cachedData) return JSON.parse(cachedData);
    try {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const sheet = ss.getSheetByName(DISCOUNT_SHEEET_NAME);
        if (!sheet) return {};
        const data = sheet.getDataRange().getValues();
        const headers = data.shift();
        const taxCodeIndex = headers.indexOf("TaxCode");
        const discountIndex = headers.indexOf("DiscountPercentage");
        if (taxCodeIndex === -1 || discountIndex === -1) return {};
        const discountMap = data.reduce((acc, row) => {
            const taxCode = row[taxCodeIndex];
            const discount = parseFloat(row[discountIndex]) / 100;
            if (taxCode && !isNaN(discount)) {
                acc[String(taxCode).trim()] = discount;
            }
            return acc;
        }, {});
        cache.put('discountData', JSON.stringify(discountMap), 600);
        return discountMap;
    } catch (e) {
        Logger.log("Lỗi khi lấy dữ liệu chiết khấu: " + e.message);
        return {};
    }
}

function handleLogin(params) {
    let response = { success: false, message: "Tài khoản hoặc mật khẩu không đúng." };
    const user = params.user ? params.user.trim().toLowerCase() : '';
    const pass = params.pass || '';
    if (ACCOUNTS[user] && ACCOUNTS[user].pass === pass) {
        response = { success: true, message: "Đăng nhập thành công!", url: ACCOUNTS[user].url };
    }
    return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
}

function handleGetDiscounts() {
    const discounts = getDiscountData();
    return ContentService.createTextOutput(JSON.stringify({ result: 'success', data: discounts })).setMimeType(ContentService.MimeType.JSON);
}

// [SỬA LỖI CORS] Hàm doGet đã được sửa
function doGet(e) {
    let responseOutput; 
    try {
        const action = e.parameter.action;
        if (action === "login") {
            responseOutput = handleLogin(e.parameter);
        } else if (action === "getDiscounts") {
            responseOutput = handleGetDiscounts();
        } else {
            responseOutput = createErrorResponse(new Error('Action không hợp lệ.'));
        }
    } catch (err) {
        Logger.log(`ERROR in doGet: ${err.message}\nStack: ${err.stack || ''}`);
        responseOutput = createErrorResponse(err);
    }
    // Thêm header để sửa lỗi CORS
    responseOutput.withHeaders({'Access-Control-Allow-Origin': '*'});
    return responseOutput; 
}


/**
 * =================================================================
 * HÀM XỬ LÝ FORM (doPost)
 * =================================================================
 */

// Hàm doPost chính (Xử lý gửi form)
function doPost(e) {
    try {
        const data = parseAndValidateInput(e);
        const { sender, shippingInfo, rentalRequests, submissionTime, unit } = data;

        const { sheet } = setupSpreadsheet(SPREADSHEET_ID, unit);
        // [SỬA] Gửi "unit" vào hàm processRentalRequests
        const newRowsRange = processRentalRequests(sheet, sender, shippingInfo, rentalRequests, submissionTime, unit); 

        // [SỬA] Gửi "unit" vào hàm sendEmails
        sendEmails(sender, shippingInfo, rentalRequests, submissionTime, unit);
        updateStatusOnSheet(sheet, newRowsRange, "Đã gửi mail", unit);

        return createSuccessResponse();
    } catch (err) {
        Logger.log(`ERROR in doPost: ${err.message}\nStack: ${err.stack || ''}`);
        return createErrorResponse(err);
    }
}

// Hàm phân tích dữ liệu đầu vào (Giữ nguyên)
function parseAndValidateInput(e) {
    if (!e || !e.postData || !e.postData.contents) throw new Error("Invalid request: No post data received");
    const data = JSON.parse(e.postData.contents);
    const unit = data.unit;
    if (!unit) throw new Error("Thiếu 'unit' để xác định sheet.");
    const sender = data.globalSenderInfo || {};
    if (!sender.email) throw new Error("Thiếu email người gửi.");
    const rentalRequests = Array.isArray(data.rentalRequests) ? data.rentalRequests : [];
    if (rentalRequests.length === 0) throw new Error("Không có yêu cầu thuê nào được gửi.");
    return { unit, submissionTime: data.submissionTime ? new Date(data.submissionTime) : new Date(), sender: data.globalSenderInfo, shippingInfo: data.shippingInfo || {}, rentalRequests };
}

// Hàm cài đặt Google Sheet (Giữ nguyên)
function setupSpreadsheet(spreadsheetId, sheetName) {
    const ss = SpreadsheetApp.openById(spreadsheetId);
    let sheet = ss.getSheetByName(sheetName);
    const columns = getColumnsForUnit(sheetName);
    if (!sheet) {
        sheet = ss.insertSheet(sheetName);
        const headers = columns.map(c => c.name);
        sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground("#f3f4f6");
        columns.forEach((c, idx) => { if (c.width) sheet.setColumnWidth(idx + 1, c.width); });
        sheet.setFrozenRows(1);
    }
    columns.forEach((c, idx) => {
        if (c.format) {
            sheet.getRange(2, idx + 1, Math.max(1, sheet.getMaxRows() - 1), 1).setNumberFormat(c.format);
        }
    });
    return { ss, sheet };
}

// [SỬA LỚN] Hàm này sẽ tính toán dựa trên "unit"
function processRentalRequests(sheet, sender, shippingInfo, rentalRequests, submissionTime, unit) {
    const columns = getColumnsForUnit(unit);
    const discounts = getDiscountData();
    const discountPercent = discounts[String(sender.taxCode).trim()] || 0;
    const recordTime = new Date();
    const startRow = sheet.getLastRow() + 1;

    const rows = rentalRequests.map((req, idx) => {
        
        // ---- BẮT ĐẦU TÍNH TOÁN LẠI ----
        const days = Number(req.days || 0);
        const unitPrice = Number(req.unitPrice || 0);
        let total, discountAmount, afterDiscount, vat, grandTotal;

        // Xử lý cho form DOANH NGHIỆP (CorporateOrders)
        if (unit === 'CorporateOrders') {
            const quantity = Number(req.quantity || 1); // Lấy 'quantity'
            total = unitPrice * days * quantity; // Tính tổng
            discountAmount = Math.round(total * discountPercent); // Tính chiết khấu
            afterDiscount = total - discountAmount;
            vat = Math.round(afterDiscount * 0.10);
            grandTotal = afterDiscount + vat;
        } 
        // Xử lý cho form ĐỐI TÁC (Mitsubishi, HIS...)
        else {
            // Logic cũ của bạn (đã sửa)
            const dataTotal = unitPrice * days;
            const insuranceTotal = Number(req.insuranceCost || 0); // (Form mới ko có, sẽ là 0)
            total = dataTotal + insuranceTotal;
            discountAmount = Math.round(total * discountPercent); // (Đối tác thường discount=0)
            afterDiscount = total - discountAmount;
            vat = Math.round(afterDiscount * 0.10);
            grandTotal = afterDiscount + vat;
        }
        
        let shippingFee = 0;
        if (idx === 0 && (unit === 'CorporateOrders' || unit === 'HIS')) { // Chỉ tính phí VC cho đơn 1 VÀ đúng loại form
             if (shippingInfo && shippingInfo.method === "Chuyển phát nhanh") {
                shippingFee = 50000;
                grandTotal += shippingFee;
             }
        }
        // ---- KẾT THÚC TÍNH TOÁN LẠI ----

        // Đẩy dữ liệu vào đúng cột
        const rowData = {
            recordTime: recordTime,
            submissionTime: submissionTime,
            emailStatus: "Đang xử lý...",
            name: sender.name,
            email: sender.email,
            phone: sender.phone,
            company: sender.company,
            region: sender.region,
            taxCode: sender.taxCode,
            requestNumber: idx + 1,
            userName: req.userName || "", // Sẽ trống nếu là Corporate
            imei: req.imei || "", // Sẽ trống nếu là Corporate
            quantity: req.quantity || null, // Sẽ trống nếu là Partner
            fromDate: parseDate(req.fromDate),
            toDate: parseDate(req.toDate),
            days: days,
            country: req.country,
            dataPackage: req.dataPackage,
            budgetCode: req.budgetCode || "", // Sẽ trống nếu là Corporate
            discountPercent: discountPercent,
            discountAmount: discountAmount,
            unitPrice: unitPrice,
            total: total,
            vat: vat,
            grandTotal: grandTotal,
            shippingMethod: idx === 0 ? (shippingInfo.method || "") : "",
            shippingFee: idx === 0 ? shippingFee : null,
            shippingDate: idx === 0 ? parseDate(shippingInfo.date) : null,
            shippingRecipient: idx === 0 ? (shippingInfo.recipient || "") : "",
            shippingPhone: idx === 0 ? (shippingInfo.phone || "") : "",
            shippingAddress: idx === 0 ? (shippingInfo.address || "") : ""
        };

        return columns.map(col => {
            const value = rowData[col.id];
            return (value === undefined || value === null) ? "" : value;
        });
    });

    if (rows.length > 0) {
        const range = sheet.getRange(startRow, 1, rows.length, columns.length);
        range.setValues(rows);
        return range;
    }
    return null;
}

// Hàm cập nhật Status (Giữ nguyên)
function updateStatusOnSheet(sheet, range, statusText, unit) {
    if (!range) return;
    const columns = getColumnsForUnit(unit);
    const colIndex = columns.findIndex(c => c.id === 'emailStatus') + 1;
    if (colIndex > 0) {
        sheet.getRange(range.getRow(), colIndex, range.getNumRows(), 1).setValue(statusText);
    }
}


/**
 * =================================================================
 * HÀM XỬ LÝ EMAIL (ĐÃ NÂNG CẤP)
 * =================================================================
 */

// [SỬA] Gửi "unit" vào hàm
function sendEmails(sender, shippingInfo, rentalRequests, submissionTime, unit) {
    const recipientEmail = sender.email;
    const recipientName = sender.name || "quý khách";
    const ccList = [...new Set(INTERNAL_CC_EMAILS.filter(Boolean))].join(",");
    const subject = `Thông tin yêu cầu thuê WiFi tại ${getCountriesTitle(rentalRequests)} - ${sender.company || recipientName}`;
    
    // [SỬA] Gửi "unit" vào hàm build HTML
    const emailData = { recipientName, sender, shippingInfo, requests: rentalRequests, unit };
    const htmlBody = buildQuotationEmail_HTML(emailData);
    const textBody = buildQuotationEmail_PlainText(emailData);

    try {
        if (recipientEmail) {
            GmailApp.sendEmail(recipientEmail, subject, textBody, {
                htmlBody: htmlBody,
                name: "MAYA VIETNAM CO., LTD",
                replyTo: ccList
            });
        }
        const internalSubject = `[Nội bộ] ${subject}`;
        GmailApp.sendEmail(ccList, internalSubject, textBody, {
            htmlBody: htmlBody,
            name: "MAYA VIETNAM CO., LTD",
            replyTo: recipientEmail
        });
    } catch (err) {
        throw new Error(`Email sending failed: ${err.message}`);
    }
}

// [SỬA LỚN] Hàm build HTML Email
function buildQuotationEmail_HTML({ recipientName, sender, shippingInfo, requests, unit }) {
    const timezone = "Asia/Ho_Chi_Minh";
    const discounts = getDiscountData();
    const discountPercent = discounts[String(sender.taxCode).trim()] || 0;
    let totalItemsCost = 0;

    const requestDetailsHTML = requests.map((req, idx) => {
        const fromDateStr = req.fromDate ? Utilities.formatDate(new Date(req.fromDate), timezone, "dd/MM/yyyy") : "";
        const toDateStr = req.toDate ? Utilities.formatDate(new Date(req.toDate), timezone, "dd/MM/yyyy") : "";
        
        // ---- BẮT ĐẦU TÍNH TOÁN LẠI (GIỐNG HÀM processRentalRequests) ----
        const days = Number(req.days || 0);
        const unitPrice = Number(req.unitPrice || 0);
        let total, discountAmount, afterDiscount, vat, grandTotal, title;
        
        if (unit === 'CorporateOrders') {
            const quantity = Number(req.quantity || 1);
            title = `Đơn ${idx + 1}: ${req.country} (SL: ${quantity})`; // Tiêu đề cho Doanh nghiệp
            total = unitPrice * days * quantity;
            discountAmount = Math.round(total * discountPercent);
            afterDiscount = total - discountAmount;
            vat = Math.round(afterDiscount * 0.10);
            grandTotal = afterDiscount + vat;
        } else {
            title = `Đơn ${idx + 1}: ${req.userName || ''}${req.imei ? " / " + req.imei : ""}`; // Tiêu đề cho Đối tác
            const dataTotal = unitPrice * days;
            const insuranceTotal = Number(req.insuranceCost || 0);
            total = dataTotal + insuranceTotal;
            discountAmount = Math.round(total * discountPercent);
            afterDiscount = total - discountAmount;
            vat = Math.round(afterDiscount * 0.10);
            grandTotal = afterDiscount + vat;
        }
        totalItemsCost += grandTotal;
        // ---- KẾT THÚC TÍNH TOÁN LẠI ----

        return `
        <div style="margin:20px 0;padding:15px;background:#f8f9fa;border-left:3px solid #2563eb;border-radius:5px;">
            <b style="color:#2563eb;">${title}</b><br>
            - Thời gian: ${fromDateStr} đến ${toDateStr} (${days} ngày)<br>
            - Quốc gia: ${req.country || ''}<br>
            - Gói cước: ${req.dataPackage || ''}<br>
            - Chi phí (gồm VAT): <b>${currency(grandTotal)}</b>
            ${ discountPercent > 0 ? `<br><span style="font-size:0.9em; color:#166534;">(Đã bao gồm chiết khấu ${ (discountPercent * 100).toFixed(0) }%)</span>` : '' }
        </div>`;
    }).join('');

    // Logic Vận chuyển (chỉ hiển thị nếu là Corporate hoặc HIS)
    const hasShippingInfo = (unit === 'CorporateOrders' || unit === 'HIS') && shippingInfo && shippingInfo.method;
    const summaryTitle = hasShippingInfo ? "Thông tin Vận chuyển & Tổng kết" : "Tổng kết Đơn hàng";

    let shippingDetailsHTML = '';
    if (hasShippingInfo) {
        shippingDetailsHTML = `
            <tr><td style="padding: 8px; border: 1px solid #ddd; width: 180px;">Người nhận hàng</td><td style="padding: 8px; border: 1px solid #ddd;"><b>${shippingInfo.recipient || ""}</b></td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Số điện thoại</td><td style="padding: 8px; border: 1px solid #ddd;">${shippingInfo.phone || ""}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Địa chỉ giao hàng</td><td style="padding: 8px; border: 1px solid #ddd;">${shippingInfo.address || ""}</td></tr>
            <tr><td style,"padding: 8px; border: 1px solid #ddd;">Ngày giao mong muốn</td><td style="padding: 8px; border: 1px solid #ddd;">${shippingInfo.date ? Utilities.formatDate(new Date(shippingInfo.date), "Asia/Ho_Chi_Minh", "dd/MM/yyyy") : ""}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Hình thức vận chuyển</td><td style="padding: 8px; border: 1px solid #ddd;">${shippingInfo.method || ""}</td></tr>
        `;
    }

    let shippingFee = 0;
    let shippingFeeRowHTML = '';
    if (hasShippingInfo) {
        let shippingFeeText = "";
        if (shippingInfo.method === "Chuyển phát nhanh") {
            shippingFee = 50000;
            shippingFeeText = currency(shippingFee);
        } else if (shippingInfo.method === "Hỏa tốc") {
            shippingFeeText = "Sẽ được báo sau (chưa bao gồm)";
        }
        shippingFeeRowHTML = `<tr><td style="padding: 8px; border: 1px solid #ddd;">Phí vận chuyển</td><td style="padding: 8px; border: 1px solid #ddd;">${shippingFeeText}</td></tr>`;
    }

    const finalGrandTotal = totalItemsCost + shippingFee;

    // Phần còn lại của HTML (Giữ nguyên)
    let html = `
    <div style="font-family:Arial,sans-serif;max-width:800px;margin:0 auto;color:#333;line-height:1.6;">
        <div style="border-bottom:2px solid #2563eb;padding-bottom:10px;margin-bottom:20px;"><div style="font-weight:bold;color:#2563eb;font-size:18px;">CÔNG TY TNHH MAYA VIETNAM</div></div>
        <div style="margin:20px 0;"><b>Kính gửi: ${sender.company || recipientName}</b><br><i>Dear ${recipientName},</i></div>
        <div>Cảm ơn Quý Công ty đã quan tâm đến dịch vụ của chúng tôi. Chúng tôi xin gửi thông tin chi tiết về yêu cầu như sau:</div>
        ${requestDetailsHTML}
    <div style="margin-top:25px; border-top: 1px solid #ccc; padding-top: 15px;">
        <h3 style="color:#2563eb; margin-bottom: 10px;">${summaryTitle}</h3>
        <table style="width:100%; border-collapse: collapse; font-size: 14px;">
            ${shippingDetailsHTML}
            <tr><td style="padding: 8px; border: 1px solid #ddd; width: 180px;">Tổng tiền hàng (gồm VAT)</td><td style="padding: 8px; border: 1px solid #ddd;">${currency(totalItemsCost)}</td></tr>
            ${shippingFeeRowHTML}
            <tr style="background-color: #f8f9fa;"><td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; font-size: 16px; color: #d32f2f;">TỔNG THANH TOÁN</td><td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; font-size: 16px; color: #d32f2f;">${currency(finalGrandTotal)}</td></tr>
        </table>
    </div>`;

    html += `
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; font-size: 14px; line-height: 1.6; color: #555;">
        <p style="margin: 0;">Trân trọng,</p>
        <p style="font-weight: bold; color: #da1a32; margin: 5px 0 0 0;">Phòng Kinh Doanh</p>
        <p style="font-weight: bold; color: #2563eb; margin: 5px 0 0 0;">MAYA VIETNAM CO., LTD</p>
        <p style="margin: 0;"><strong>Địa chỉ:</strong> Phòng 1630, Tầng 16, DAEHA BUSINESS CENTER, 360 Kim Mã, Giảng Võ, Hà Nội</p>
        <p style="margin: 0;"><strong>Hotline (VN):</strong> 0962 000 650 | <strong>Hotline (JP):</strong> 0365 399 288</p>
        <p style="margin: 0;"><strong>Email:</strong> <a href="mailto:info@ezfivn.com" style="color: #2563eb; text-decoration: none;">info@ezfivn.com</a></a</p>
        <p style="margin: 0;"><strong>Website:</strong> <a href="https://mayavietnam.com/" style="color: #2563eb; text-decoration: none;">mayavietnam.com</a></p>
    </div>
    <div style="margin-top:20px;padding-top:15px;border-top:1px solid #eee;color:#777;text-align:center;font-size:12px;"><i>Đây là email tự động, vui lòng không trả lời trực tiếp.</i></div>
    </div>`;
    return html;
}

// [SỬA LỚN] Hàm build Email dạng Text
function buildQuotationEmail_PlainText({ sender, requests, submissionTime, unit }) {
    const submissionTimeFormatted = Utilities.formatDate(new Date(submissionTime), "Asia/Ho_Chi_Minh", "dd/MM/yyyy HH:mm");
    let text = `Kính gửi: ${sender.company || sender.name}\n\n`;
    text += `Công ty TNHH Maya Vietnam xin chân thành cảm ơn Quý Công ty đã quan tâm đến dịch vụ của chúng tôi.\n\n`;
    requests.forEach((req, idx) => {
        text += `----------------------------------------\n`;
         if (unit === 'CorporateOrders') {
            text += `Đơn ${idx + 1}: ${req.country} (SL: ${req.quantity})\n`;
        } else {
            text += `Đơn ${idx + 1}: ${req.userName}\n`;
        }
        text += `- Chi phí (gồm VAT): (Vui lòng xem chi tiết trong email HTML)\n\n`;
    });
    text += `----------------------------------------\n`;
    text += `Trân trọng cảm ơn Quý khách!\n`;
    text += `Ngày gửi: ${submissionTimeFormatted}\n`;
    return text;
}

// Các hàm trợ giúp cuối cùng (Giữ nguyên)
function createSuccessResponse() { return ContentService.createTextOutput(JSON.stringify({ result: 'success' })).setMimeType(ContentService.MimeType.JSON); }
function createErrorResponse(err) { return ContentService.createTextOutput(JSON.stringify({ result: 'error', error: err.message || String(err) })).setMimeType(ContentService.MimeType.JSON); }
function currency(vnd) { if (typeof vnd !== 'number' || isNaN(vnd)) return "-"; return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(vnd); }
function getCountriesTitle(requests) { const countries = [...new Set((requests || []).map(r => r.country).filter(Boolean))]; return countries.join(", "); }
function parseDate(input) { if (!input) return null; if (input instanceof Date) return input; if (typeof input === 'string') { const iso = new Date(input); if (!isNaN(iso)) return iso; } return null; }